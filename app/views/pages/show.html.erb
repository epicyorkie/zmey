<%= flash_notice %>
<%= raw textilize(@page.content) %>
<% unless @page.children.empty? -%>
<div id="child_pages">
  <% @page.children.each do |child| -%>
  <div class="child_page">
    <p class="child_page_image">
      <% unless child.image.nil? -%>
      <%= link_to image_tag(child.image.url(@w.page_thumbnail_size), :alt => child.image.name), child.path %>
      <% end -%>
    </p>
    <%= link_to child.name, child.path %>
  </div>
  <% end -%>
</div>
<% end -%>
<%= template("product_summaries_before") %>
<% @page.product_placements.each do |placement| %>
  <% product = placement.product %>
  <%=
  template('product_summary',
    :full => false,
    :page => @page,
    :placement => placement,
    :price => formatted_price(product.price_with_tax(1, @inc_tax)),
    :product => product,
    :product_features => render(:partial => "products/product_features", :locals => {:product => product}),
    :product_image_url => product.image.nil? ? '' : product.image.url(@w.product_thumbnail_size)
    )
  %>
  <%= render :partial => 'products/admin_controls', :locals => {:product => product, :placement => placement } %>
<% end %>
<%= template("product_summaries_after") %>
<% if admin_or_manager? -%>
<div id="page_admin_controls">
  <h2>Admin Controls</h2>
  <!-- I probably need moving to product_placement/_form.html -->
  <% unless @w.products.empty? -%>
  <%= form_for @product_placement do |form| %>
  <input type="hidden" name="product_placement[page_id]" value="<%= @page.id %>" />
  <%= form.collection_select :product_id, @w.products, :id, :name_with_sku %>
  <%= submit_tag 'Add Product' %>
  <% end %>
  <% end -%>
  <p><%= link_to 'Edit this page', :action => 'edit', :id => @page.id %></p>
  <%= form_tag :controller => 'pages', :action => 'destroy', :id => @page.id do -%>
    <input type="submit" value="Delete Page" />
  <% end -%>
</div>
<% end -%>